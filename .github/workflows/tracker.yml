- name: Run merge script
  run: |
    cat << 'EOF' > merge.py
    import requests
    import re

    SOURCES = [
        "https://raw.githubusercontent.com/ngosang/trackerslist/master/trackers_best.txt",
        "https://raw.githubusercontent.com/ngosang/trackerslist/master/trackers_best_ip.txt",
        "https://cf.trackerslist.com/best.txt",
        "https://github.itzmx.com/1265578519/OpenTracker/master/tracker.txt"
    ]

    def process_trackers():
        trackers = set()

        for url in SOURCES:
            try:
                resp = requests.get(url, timeout=15)
                resp.raise_for_status()
                
                for line in resp.text.splitlines():
                    line = line.strip()
                    if not line:
                        continue
                    
                    # 统一校验协议，不区分类型
                    if re.match(r'^(udp|http|https|wss|tcp)://', line):
                        trackers.add(line)
                    else:
                        print(f"Ignoring invalid line: {line}")
                        
            except Exception as e:
                print(f"Failed to fetch {url}: {str(e)}")

        # 合并并统一排序
        sorted_trackers = sorted(trackers)

        # 写入文件（无协议分类）
        with open("tracker.txt", "w") as f:
            f.write("\n".join(sorted_trackers))

    if __name__ == "__main__":
        process_trackers()
    EOF

    python merge.py
